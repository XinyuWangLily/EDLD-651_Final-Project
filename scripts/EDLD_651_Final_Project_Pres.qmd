---
title: "Final Project"
authors: "Xinyu (Lily) Wang, Sophie Hartford, Everett Mahaffy"
format:
  revealjs:
    embed-resources: true
    highlight-style: tango
execute:
  eval: true
  echo: true
  fig-width: 12
  fig-height: 7
warning: false
message: false

---

# Load packages

```{r}
library(tidyverse)
library(flextable)
library(here)
library(readxl)
library(modelsummary)
library(janitor)
library(performance)
library(ggplot2)
```

# Load data

```{r}
# Demographic
age <- read_csv(here("data", "TAG_age_session_dates_4waves.csv"))
age <- clean_names(age)

race <- read_excel(here("data", "TAG_W1_Race_Ethnicity.xlsx"))
race <- clean_names(race)

# Emotion Regulation(ERQ)
erq <- read_csv(here("data", "ERQ_Wave1.csv"))
erq <- erq %>% 
       clean_names() %>% 
       distinct(tagid, .keep_all = TRUE)

# Adolescent Depression(CESDC)
cesdc <- read_csv(here("data", "CESDC_Wave1.csv"))
cesdc <- clean_names(cesdc)

```

# Study Info

We will be utilizing data from the longitudinal study “Transitions in Adolescent Girls,” (Barendse et al., 2020) specifically focusing on data from baseline (Wave 1). This dataset includes 174 participants who were 10-13 at the baseline. Our variables of interest are emotion regulation strategy use and depressive symptoms. These were measured using the Emotion Regulation Questionnaire (ERQ; John & Gross, 2003) and the Center for Epidemiological Studies Depression Scale for Children (CES- DC, Weissman et al., 1980). These are continuous scales which provide total scores for reappraisal and suppression (ERQ) and depressive symptoms (CES-DC).

# Participant Demographics

Race/ethnicity category

Clean the data frame: identify subjects reported multiple racial categories and rename them to "Multi-racial"

```{r}
race_clean <- race %>%
  mutate(
    w1_ethnicity = as.character(w1_ethnicity),
    w1_ethnicity = if_else(
      str_detect(w1_ethnicity, ","),
      "g. Multi-racial",
      w1_ethnicity
    )
  )
```

# Participant demographics cont.

Age

We have subject age data at both sessions and we are interested in calculating the mean age of the two sessions of wave1

```{r}
age <- age %>% 
  mutate(W1_mean_age = (w1s1_age + w1s2_age)/2) 

# Check mean age for sample
age_summary <- age %>%
  summarize(
    mean_W1_age = mean(W1_mean_age, na.rm = TRUE),
    sd_W1_age   = sd(W1_mean_age, na.rm = TRUE),
  )
print(age_summary)
```

# Join all data frames

```{r}
df <- erq %>% 
  left_join(cesdc, by= 'tagid')

df <- df %>% 
     left_join(age, by = 'tagid')

df <- df %>% 
     left_join(race_clean, by = 'tagid') %>% 
     select(tagid, erq_reappraisal_total, erq_suppression_total, ces_dc_total_75perc, W1_mean_age, w1_ethnicity, 
            w1s1_date, w1s1_age, w1s2_date, w1s2_age, w2s1_date, w2s1_age, w2s2_date, w2s2_age, 
            w3s1_date, w3s1_age, w3s2_date, w3s2_age, w4s1_date, w4s1_age, w4s2_date, w4s2_age
            )

df <- df %>%
  rename(
    wave1_session1_date = w1s1_date,
    wave1_session1_age  = w1s1_age,
    wave1_session2_date = w1s2_date,
    wave1_session2_age  = w1s2_age,

    wave2_session1_date = w2s1_date,
    wave2_session1_age  = w2s1_age,
    wave2_session2_date = w2s2_date,
    wave2_session2_age  = w2s2_age,

    wave3_session1_date = w3s1_date,
    wave3_session1_age  = w3s1_age,
    wave3_session2_date = w3s2_date,
    wave3_session2_age  = w3s2_age,

    wave4_session1_date = w4s1_date,
    wave4_session1_age  = w4s1_age,
    wave4_session2_date = w4s2_date,
    wave4_session2_age  = w4s2_age
  )
```

# Tidy and filter

```{r}
# Tidy
df2 <- df %>%
  mutate(across(starts_with("wave"), as.character))

df_long <- df2 %>%
  pivot_longer(
    cols = starts_with("wave"),
    names_to = c("wave", "session", "info"),
    names_sep = "_",
    values_to = "value"
  ) %>%
  mutate(
    wave    = parse_number(wave),
    session = parse_number(session)
  )

df_tidy <- df_long %>%
  pivot_wider(
    names_from = info,
    values_from = value
  )

# Filter
df_final <- df_tidy %>% 
  filter(wave == 1, session == 1)
```

# Cohort Plot

```{r}
ggplot(df_tidy, aes(x = age, y = tagid)) +
  geom_line(aes(group = tagid), size = .5, alpha = .4) +
  geom_point(aes(color = as.factor(wave)), size = 2) +
  labs(
    x = "Age",
    y = "TAG Participant",
    title = "Age by Wave",
    color = "Wave"
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```

# Sample Summary Statistics

```{r}
df_names <- df_tidy %>% 
    select(-wave, -session) %>% 
    rename(
    Reappraisal       = erq_reappraisal_total,
    Suppression       = erq_suppression_total,
    Depression        = ces_dc_total_75perc,
    Age               = W1_mean_age,
    Ethnicity         = w1_ethnicity
    )
```

# Summary Stats Table
```{r}
datasummary_skim(df_names,
                 title = "Table 1. Sample Descriptive Statistics")
```

# RQ 1

Is higher emotion reappraisal associated with lower depression symptoms in adolescent girls?

```{r}
rq1 <- lm(df_tidy$ces_dc_total_75perc ~ df_tidy$erq_reappraisal_total)
check_model(rq1)
```

# RQ 2

Is higher emotion suppression associated with higher depression symptoms in adolescent girls?

```{r}
rq2 <- lm(df_tidy$ces_dc_total_75perc ~ df_tidy$erq_suppression_total)
check_model(rq2)
```

# Exploratory 

Is higher suppression use associated with higher depression symptoms when adjusting for reappraisal use?

```{r}
ex1 <- lm(df_tidy$ces_dc_total_75perc ~ df_tidy$erq_suppression_total + df_tidy$erq_reappraisal_total)
check_model(ex1)
```

Does age moderate the relation between reappraisal/suppression and depression symptoms in adolescent girls?

```{r}
ex2 <- lm(df_tidy$ces_dc_total_75perc ~ df_tidy$erq_reappraisal_total * df_tidy$W1_mean_age)
check_model(ex2)

ex3 <- lm(df_tidy$ces_dc_total_75perc ~ df_tidy$erq_suppression_total * df_tidy$W1_mean_age)
check_model(ex3)
```

# Results

Primary RQ Tables
```{r}
modelsummary(
  list(
    "Reappraisal" = rq1,
    "Suppression" = rq2),
  coef_map = c(
    "(Intercept)"                     = "Intercept",
    "df_tidy$erq_reappraisal_total"   = "Reappraisal (ERQ)",
    "df_tidy$erq_suppression_total"   = "Suppression (ERQ)"
  ),
  stars = TRUE,
  title = "Table 2. Model Summary for RQ1 and RQ2"
  )
```

# Exploratory Results

```{r}
modelsummary(
  list(
    "Suppression + Reappraisal" = ex1,
    "Reappraisal × Age Interaction" = ex2,
    "Suppression × Age Interaction" = ex3),
    coef_map = c(
    "(Intercept)"                     = "Intercept",
    "df_tidy$erq_reappraisal_total"   = "Reappraisal (ERQ)",
    "df_tidy$erq_suppression_total"   = "Suppression (ERQ)",
    "df_tidy$erq_reappraisal_total:df_tidy$W1_mean_age" = "Reappraisal x Age",
    "df_tidy$erq_suppression_total:df_tidy$W1_mean_age" = "Suppression x Age"),
  stars = TRUE,
  title = "Table 3. Model Summaries for Multiple Regression and Interaction Models"
  )
```

# Plot 1

```{r}
ggplot(df_tidy, aes(x=erq_reappraisal_total, y=ces_dc_total_75perc))+
  geom_point(color="Dodgerblue3")+
  geom_smooth(method = lm, color="Aquamarine3")+
  labs(x="Reappraisal", y="Depression")
```

# Plot 2

```{r}
ggplot(df_tidy,aes(x=erq_suppression_total, y=ces_dc_total_75perc))+
  geom_point(color="Dodgerblue3")+
  geom_smooth(method = lm, color="Aquamarine3")+
  labs(x="Suppression", y="Depression")
```
