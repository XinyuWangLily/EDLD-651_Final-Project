---
title: "Final Project"
authors: "Xinyu (Lily) Wang, Sophie Hartford, Everett Mahaffy"
format:
  html:
    code-fold: true
    code-summary: "Show the code"
    toc: true
    embed-resources: true
    highlight-style: tango
execute:
  eval: true
  echo: true
warning: false
message: false
scrollable: true
#I remember from your slides there was some trouble showing the full table without it being cut off, the scrollable:true should fix that. I know it isn't directly related to your code here but I thought it'd be helpful to see!
---

# Load packages

```{r}
#| label: Loading Packages
library(tidyverse)
library(flextable)
library(here)
library(readxl)
library(modelsummary)
library(janitor)
library(performance)
library(ggplot2)
```

# Load data

```{r}
#| label: Loading in data

# Demographic
age <- read_csv(here("data", "TAG_age_session_dates_4waves.csv"))
age <- clean_names(age)

race <- read_excel(here("data", "TAG_W1_Race_Ethnicity.xlsx"))
race <- clean_names(race)

# Emotion Regulation(ERQ)
erq <- read_csv(here("data", "ERQ_Wave1.csv"))
erq <- erq %>% 
       clean_names() %>% 
       distinct(tagid, .keep_all = TRUE)

# Adolescent Depression(CESDC)
cesdc <- read_csv(here("data", "CESDC_Wave1.csv"))
cesdc <- clean_names(cesdc)

```

# Participant demographics
## Race/ethnicity category
### Clean the data frame: identify subjects reported multiple racial categories and rename them to "Multi-racial"

```{r}
#| label: Cleaning data
race_clean <- race %>%
  mutate(
    w1_ethnicity = as.character(w1_ethnicity),
    w1_ethnicity = if_else(
      str_detect(w1_ethnicity, ","),
      "g. Multi-racial",
      w1_ethnicity
    )
  )
```

# Age
## We have subject age data at both sessions and we are interested in calculating the mean age of the two sessions of wave1. 

```{r}
#| label: Cleaning data cont. 
age <- age %>% 
  mutate(W1_mean_age = (w1s1_age + w1s2_age)/2) 

# Check mean age for sample
age_summary <- age %>%
  summarize(
    mean_W1_age = mean(W1_mean_age, na.rm = TRUE),
    sd_W1_age   = sd(W1_mean_age, na.rm = TRUE),
  )
print(age_summary)
```

# Join all data frames

```{r}
#| label: Tidying data

df <- erq %>% 
  left_join(cesdc, by= 'tagid')

df <- df %>% 
     left_join(age, by = 'tagid')

df <- df %>% 
     left_join(race_clean, by = 'tagid') %>% 
     select(tagid, erq_reappraisal_total, erq_suppression_total, ces_dc_total_75perc, W1_mean_age, w1_ethnicity, 
            w1s1_date, w1s1_age, w1s2_date, w1s2_age, w2s1_date, w2s1_age, w2s2_date, w2s2_age, 
            w3s1_date, w3s1_age, w3s2_date, w3s2_age, w4s1_date, w4s1_age, w4s2_date, w4s2_age
            )

df <- df %>%
  rename(
    wave1_session1_date = w1s1_date,
    wave1_session1_age  = w1s1_age,
    wave1_session2_date = w1s2_date,
    wave1_session2_age  = w1s2_age,

    wave2_session1_date = w2s1_date,
    wave2_session1_age  = w2s1_age,
    wave2_session2_date = w2s2_date,
    wave2_session2_age  = w2s2_age,

    wave3_session1_date = w3s1_date,
    wave3_session1_age  = w3s1_age,
    wave3_session2_date = w3s2_date,
    wave3_session2_age  = w3s2_age,

    wave4_session1_date = w4s1_date,
    wave4_session1_age  = w4s1_age,
    wave4_session2_date = w4s2_date,
    wave4_session2_age  = w4s2_age
  )
```

# Tidy and filter

```{r}
#| label: Tidying data cont. 
# Tidy
df2 <- df %>%
  mutate(across(starts_with("wave"), as.character))

df_long <- df2 %>%
  pivot_longer(
    cols = starts_with("wave"),
    names_to = c("wave", "session", "info"),
    names_sep = "_",
    values_to = "value"
  ) %>%
  mutate(
    wave    = parse_number(wave),
    session = parse_number(session)
  )

df_tidy <- df_long %>%
  pivot_wider(
    names_from = info,
    values_from = value
  ) %>% 
  mutate(age = as.numeric(age))


# Filter
df_final <- df_tidy %>% 
  filter(wave == 1, session == 1)

```

# Results

*Cohort Plot*

```{r echo=FALSE}
#| label: Cohort plot
ggplot(df_tidy, aes(x = age, y = tagid)) +
  geom_line(aes(group = tagid), size = .5, alpha = .4) +
  geom_point(aes(color = as.factor(wave)), size = 2) +
  labs(
    x = "Age",
    y = "TAG Participant",
    title = "Age by Wave",
    color = "Wave"
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  ) +
 scale_x_continuous(breaks = seq(10, 20, by = 0.5))

```


# Sample Summary Statistics

```{r}
#| label: Sample Summary Statistics 
df_names <- df_tidy %>% 
    select(-wave, -session) %>% 
    rename(
    Reappraisal       = erq_reappraisal_total,
    Suppression       = erq_suppression_total,
    Depression        = ces_dc_total_75perc,
    Age               = W1_mean_age,
    Ethnicity         = w1_ethnicity
    )
datasummary_skim(df_names,
                 title = "Table 1. Sample Descriptive Statistics")
```

# RQ 1

*Is higher emotion reappraisal associated with lower depression symptoms in adolescent girls?*

```{r}
#| label: Linear regression 1

rq1<-lm(ces_dc_total_75perc~erq_reappraisal_total, data = df_tidy)
check_model(rq1,
  size_dot = 1,
  size_line = 0.5,
  size_title = 8,
  size_axis_title = 5,
  alpha = 0.1,
  alpha_dot = 0.1,
  base_size = 8)
```

# RQ 2

*Is higher emotion suppression associated with higher depression symptoms in adolescent girls?*

```{r}
#| label: Linear regression 2

rq2<-lm(ces_dc_total_75perc~erq_suppression_total, data = df_tidy)

#I noticed the model checks visuals looked a bit crowded, so I added in some code to all the model_check() to make things a bit more spaced out! 
check_model(rq2,
  size_dot = 1,
  size_line = 0.5,
  size_title = 8,
  size_axis_title = 5,
  alpha = 0.1,
  alpha_dot = 0.1,
  base_size = 8)


```

# Exploratory 

*Is higher suppression use associated with higher depression symptoms when adjusting for reappraisal use?*

```{r}
#| label: Exploratory Linear regression 3

ex1 <- lm(ces_dc_total_75perc ~ erq_suppression_total + erq_reappraisal_total, data = df_tidy)
check_model(ex1,
  size_dot = 1,
  size_line = 0.5,
  size_title = 8,
  size_axis_title = 5,
  alpha = 0.1,
  alpha_dot = 0.1,
  base_size = 8)
```

*Does age moderate the relation between reappraisal/suppression and depression symptoms in adolescent girls?*

```{r}
#| label: Moderation

library(gtsummary)

ex2 <- lm(ces_dc_total_75perc ~ erq_reappraisal_total * W1_mean_age, data = df_tidy)
check_model(ex2,
  size_dot = 1,
  size_line = 0.5,
  size_title = 8,
  size_axis_title = 5,
  alpha = 0.1,
  alpha_dot = 0.1,
  base_size = 8)

ex3 <- lm(ces_dc_total_75perc ~ erq_suppression_total * W1_mean_age, data = df_tidy)
check_model(ex3,
  size_dot = 1,
  size_line = 0.5,
  size_title = 8,
  size_axis_title = 5,
  alpha = 0.1,
  alpha_dot = 0.1,
  base_size = 8)

#The plots look great, but if you wanted to also show a table for your regression results, here's some code below to do that. I used library(gtsummary) to get this in. 
ex3 |> 
  gtsummary::tbl_regression()
```

# Results

## Tables
```{r}
#| label: Results
modelsummary(
  list(
    "Reappraisal" = rq1,
    "Suppression" = rq2),
  coef_map = c(
    "(Intercept)"                     = "Intercept",
    "erq_reappraisal_total"   = "Reappraisal (ERQ)",
    "erq_suppression_total"   = "Suppression (ERQ)"
  ),
  stars = TRUE,
  title = "Table 2. Model Summary for RQ1 and RQ2"
  )

modelsummary(
  list(
    "Suppression + Reappraisal" = ex1,
    "Reappraisal × Age Interaction" = ex2,
    "Suppression × Age Interaction" = ex3),
    coef_map = c(
    "(Intercept)"                     = "Intercept",
    "erq_reappraisal_total"   = "Reappraisal (ERQ)",
    "erq_suppression_total"   = "Suppression (ERQ)",
    "erq_reappraisal_total:W1_mean_age" = "Reappraisal x Age",
    "erq_suppression_total:W1_mean_age" = "Suppression x Age"),
  stars = TRUE,
  title = "Table 3. Model Summaries for Multiple Regression and Interaction Models"
  )
```

## Plots
```{r}
#| label: Plots

## two scatter plots with regression lines (method lm) here: one for reappraisal (x axis) and one for suppression (x axis); y axis will be depression for both. I added the summaries to assess correlation between both suppression and reappraisal and depression
ggplot(df_tidy, aes(x=erq_reappraisal_total, y=ces_dc_total_75perc))+
  geom_point(color="Dodgerblue3")+
  geom_smooth(method = lm, color="Aquamarine3")+
  labs(x="Reappraisal", y="Depression")
ggplot(df_tidy,aes(x=erq_suppression_total, y=ces_dc_total_75perc))+
  geom_point(color="Dodgerblue3")+
  geom_smooth(method = lm, color="Aquamarine3")+
  labs(x="Suppression", y="Depression")
Suppression<-lm(ces_dc_total_75perc ~ erq_suppression_total, data = df_tidy)
summary(Suppression)
Depression<-lm(ces_dc_total_75perc~erq_reappraisal_total, data = df_tidy)
summary(Depression)
```
#Interaction Plot
```{r}
#| label: Interaction plot

df_final <- df_tidy %>%
  filter(wave == 1, session == 1) %>%
  mutate(
    age_group_2 = case_when(
      W1_mean_age >= 10 & W1_mean_age < 12 ~ "10–11",
      W1_mean_age >= 12 & W1_mean_age <= 13 ~ "12–13",
      TRUE ~ NA_character_
    ))
#Reappraisal and Depression
ggplot(
  df_final%>%filter(!is.na(age_group_2)),
  aes(
    x=erq_reappraisal_total,
    y=ces_dc_total_75perc,
    linetype = age_group_2
  )
)+
  geom_smooth(
    method = "lm",
    se=TRUE,
    fullrange=TRUE,
    color="Aquamarine3",
    linewidth=1,
    alpha=0.15
  )+
  labs(
    x="Reappraisal",
    y="Depression",
    linetype="Age Group",
    title = "Plot 1: Interaction of Reappraisal and Age Predicting Depression Symptoms"
  )+
  scale_linetype_manual(values = c("solid","dashed"))+
  theme_classic(base_size = 18)+
  theme(
    legend.position = "bottom",
    legend.key = element_blank()
  )
#Suppression and Depression
ggplot(
  df_final %>% filter(!is.na(age_group_2)),
  aes(
    x = erq_suppression_total,
    y = ces_dc_total_75perc,
    linetype = age_group_2
  )
) +
  geom_smooth(
    method    = "lm",
    se        = TRUE,
    fullrange = TRUE,
    color     = "Aquamarine3",
    linewidth = 1,
    alpha     = 0.15
  ) +
  labs(
    x   = "Suppression",
    y   = "Depression",
    linetype = "Age Group",
    title = "Plot 2: Interaction of Suppression and Age Predicting Depression Symptoms"
  ) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  theme_classic(base_size = 18) +
  theme(
    legend.position = "bottom",
    legend.key      = element_blank()
  )


```

# Discussion
## [ to do later ]